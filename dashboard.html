<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="symptomate_logo_small.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Symptomate | Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="nav-brand">
        <img src="symptomate_logo_small.png" alt="Symptomate Logo" class="nav-logo">
        <span class="nav-title">Symptomate</span>
      </div>
      <div class="nav-links">
        <a href="index.html" class="nav-link">Chat</a>
        <a href="dashboard.html" class="nav-link active">Dashboard</a>
        <a href="settings.html" class="nav-link">Settings</a>
        <div class="user-badge" id="userBadge" style="display: none;">
          <span class="user-badge-icon">üë§</span>
          <span id="userName">User</span>
        </div>
        <button class="logout-btn" id="logoutBtn" style="display: none;" onclick="handleLogout()">Logout</button>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Dashboard Content -->
      <main class="dashboard">
      <!-- Welcome Section -->
      <section class="welcome-section">
        <h1>Welcome back! üëã</h1>
        <p>Here's your health overview and quick access to features.</p>
      </section>

      <!-- Quick Actions -->
      <section class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-cards">
          <div class="action-card primary">
            <div class="card-icon">üí¨</div>
            <h3>Start New Chat</h3>
            <p>Begin a new conversation with your AI health assistant</p>
            <a href="index.html" class="card-button">Start Chat</a>
          </div>
          
          <div class="action-card secondary">
            <div class="card-icon">üìä</div>
            <h3>My Reports</h3>
            <p>View your health reports and symptom history</p>
            <button class="card-button" onclick="openReports()">View Reports</button>
          </div>

          <div class="action-card tertiary">
            <div class="card-icon">‚öôÔ∏è</div>
            <h3>Settings</h3>
            <p>Customize your experience and preferences</p>
            <a href="settings.html" class="card-button">Open Settings</a>
          </div>
        </div>
      </section>

      <!-- Triage Support -->
      <section class="triage-support">
        <div class="triage-support-header">
          <div>
            <h2>Care Guidance</h2>
            <p>Your latest triage severity determines the next best step.</p>
          </div>
          <div class="triage-legend">
            <span class="legend-dot low"></span>Low
            <span class="legend-dot moderate"></span>Moderate
            <span class="legend-dot high"></span>High
            <span class="legend-dot emergency"></span>Emergency
          </div>
        </div>
        <div id="triageCard" class="triage-card empty">
          <div class="triage-card-empty">
            <h3>No triage data yet</h3>
            <p>Start a chat so Symptomate can log your symptoms and guide you.</p>
            <a href="index.html" class="btn-small">Start Chat</a>
          </div>
        </div>
      </section>

      <!-- Health History -->
      <section class="health-history">
        <h2>Recent Health Activity</h2>
        <div class="history-cards">
          <div class="history-item">
            <div class="history-icon">ü§í</div>
            <div class="history-content">
              <h4>Fever & Fatigue</h4>
              <p>Yesterday ‚Ä¢ 2:30 PM</p>
              <span class="status resolved">Resolved</span>
            </div>
          </div>
          
          <div class="history-item">
            <div class="history-icon">ü§ß</div>
            <div class="history-content">
              <h4>Cold Symptoms</h4>
              <p>3 days ago ‚Ä¢ 10:15 AM</p>
              <span class="status ongoing">Ongoing</span>
            </div>
          </div>
          
          <div class="history-item">
            <div class="history-icon">üò¥</div>
            <div class="history-content">
              <h4>Sleep Issues</h4>
              <p>1 week ago ‚Ä¢ 9:45 PM</p>
              <span class="status resolved">Resolved</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Saved Chats -->
      <section class="saved-chats">
        <h2>Recent Conversations</h2>
        <div class="chat-list">
          <div class="chat-item">
            <div class="chat-preview">
              <h4>Headache & Eye Strain</h4>
              <p>Started 2 hours ago</p>
            </div>
            <div class="chat-actions">
              <button class="btn-small">Continue</button>
              <button class="btn-small secondary">Delete</button>
            </div>
          </div>
          
          <div class="chat-item">
            <div class="chat-preview">
              <h4>Stomach Pain Discussion</h4>
              <p>Started yesterday</p>
            </div>
            <div class="chat-actions">
              <button class="btn-small">Continue</button>
              <button class="btn-small secondary">Delete</button>
            </div>
          </div>
          
          <div class="chat-item">
            <div class="chat-preview">
              <h4>Cold & Congestion</h4>
              <p>Started 3 days ago</p>
            </div>
            <div class="chat-actions">
              <button class="btn-small">Continue</button>
              <button class="btn-small secondary">Delete</button>
            </div>
          </div>
        </div>
      </section>
      </main>
    </div>
    
    <!-- Reports Modal -->
    <div id="reportsModal" class="reports-modal" style="display:none;">
      <div class="reports-modal-backdrop" onclick="closeReportsModal()"></div>
      <div class="reports-modal-content">
        <h2>My Health Reports</h2>
        <p class="reports-subtitle">Generated from your recent Symptomate consultations.</p>
        <div id="reportsBody" class="reports-body">
          <!-- Filled dynamically -->
        </div>
        <div class="reports-modal-actions">
          <button class="btn-small secondary" type="button" onclick="closeReportsModal()">Close</button>
          <button class="btn-small" type="button" onclick="downloadReport()">Download as PDF</button>
        </div>
      </div>
    </div>
    
    <!-- App Footer -->
    <footer class="app-footer">
      <p>Symptomate ¬© 2025 | Your friendly AI Health Assistant</p>
    </footer>
  </div>

  <script src="utils.js"></script>
  <script src="script.js"></script>
  <script>
    // Simple HTML escape to keep reports safe
    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function openReports() {
      const modal = document.getElementById('reportsModal');
      const body = document.getElementById('reportsBody');
      if (!modal || !body) return;

      body.innerHTML = '<p>Loading your reports...</p>';
      modal.style.display = 'block';

      try {
        const res = await fetch('/api/history');
        if (!res.ok) throw new Error('Failed to load history');
        const history = await res.json();

        if (!history || history.length === 0) {
          body.innerHTML = '<p>No health activity found yet. Start a chat to generate your first report.</p>';
          return;
        }

        const entries = history.slice().reverse(); // newest first
        const reportSections = entries.map((item, index) => {
          const timestamp = item.timestamp
            ? new Date(item.timestamp * 1000).toLocaleString()
            : 'Unknown time';
          const triage = item.triage || {};
          const causes = triage.causes || triage.possible_causes || [];
          const suggestions = triage.suggestions || [];
          const severity = (triage.severity || 'low').toLowerCase();
          const severityLabel = severity.charAt(0).toUpperCase() + severity.slice(1);

          const title =
            causes[0] ||
            (item.user_message ? item.user_message.slice(0, 40) + (item.user_message.length > 40 ? '...' : '') : 'Consultation');

          const suggestionsHtml = suggestions.length
            ? '<ul class="report-entry-suggestions">' +
              suggestions.map(s => `<li>${escapeHtml(s)}</li>`).join('') +
              '</ul>'
            : '';

          return `
            <div class="report-entry">
              <div class="report-entry-header">
                <h3>Consultation #${entries.length - index}: ${escapeHtml(title)}</h3>
                <span class="status ${escapeHtml(severity)}">${escapeHtml(severityLabel)}</span>
              </div>
              <p class="report-entry-date">${escapeHtml(timestamp)}</p>
              ${
                item.user_message
                  ? `<p class="report-entry-message"><strong>What you shared:</strong> ${escapeHtml(item.user_message)}</p>`
                  : ''
              }
              ${
                causes.length
                  ? `<p class="report-entry-causes"><strong>Possible causes (non-diagnostic):</strong> ${escapeHtml(
                      causes.join(', ')
                    )}</p>`
                  : ''
              }
              ${suggestionsHtml}
            </div>
          `;
        });

        body.innerHTML = reportSections.join('');
      } catch (err) {
        console.error('Error loading reports:', err);
        body.innerHTML = '<p>Unable to generate reports right now. Please try again later.</p>';
        if (typeof showToast === 'function') {
          showToast('Error', 'Unable to load your reports.', 'error', 3000);
        }
      }
    }

    function closeReportsModal() {
      const modal = document.getElementById('reportsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function downloadReport() {
      const body = document.getElementById('reportsBody');
      if (!body || !body.innerHTML.trim()) return;

      const reportHtml = body.innerHTML;
      const win = window.open('', '_blank');
      if (!win) return;

      win.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="UTF-8" />
            <title>Symptomate - Health Report</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; color: #111827; }
              h1 { text-align: center; margin-bottom: 10px; }
              h2 { text-align: center; margin-top: 0; color: #6B7280; font-size: 0.95rem; }
              .report-entry { border: 1px solid #E5E7EB; border-radius: 8px; padding: 12px 16px; margin-bottom: 10px; }
              .report-entry-header { display: flex; justify-content: space-between; align-items: center; }
              .report-entry-date { font-size: 0.85rem; color: #6B7280; }
              .report-entry-message, .report-entry-causes { margin: 8px 0; }
              .report-entry-suggestions { margin: 6px 0 0 20px; font-size: 0.9rem; }
              .status { padding: 3px 10px; border-radius: 999px; font-size: 0.75rem; text-transform: capitalize; }
              .status.low { background: #D1FAE5; color: #065F46; }
              .status.moderate { background: #FEF3C7; color: #92400E; }
              .status.high { background: #FEE2E2; color: #991B1B; }
              .status.emergency { background: #FECACA; color: #7F1D1D; font-weight: bold; }
            </style>
          </head>
          <body>
            <h1>Symptomate Health Report</h1>
            <h2>Generated on ${new Date().toLocaleString()}</h2>
            ${reportHtml}
          </body>
        </html>
      `);
      win.document.close();

      // Give the new window a moment to render, then open print dialog
      win.focus();
      setTimeout(() => {
        win.print();
      }, 500);

      if (typeof showToast === 'function') {
        showToast('Report Ready', 'Use your browser\'s print dialog to save as PDF.', 'success', 3000);
      }
    }

    // Dark mode functionality
    function toggleDarkMode(isDark) {
      if (isDark) {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    }

    // Load dark mode preference on page load
    document.addEventListener('DOMContentLoaded', function() {
      const darkMode = localStorage.getItem('symptomate_dark_mode') === 'true';
      toggleDarkMode(darkMode);
      
      const userData = JSON.parse(localStorage.getItem('symptomate_user') || 'null');
      if (!userData || !userData.isLoggedIn) {
        window.location.href = 'splash.html';
      } else {
        const userBadge = document.getElementById('userBadge');
        const userName = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        
        if (userBadge && userName && logoutBtn) {
          userName.textContent = userData.name || 'User';
          userBadge.style.display = 'flex';
          logoutBtn.style.display = 'block';
        }
      }
      
      // Load health history
      if (typeof loadHealthHistory === 'function') {
        loadHealthHistory();
      }
    });
    
    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('symptomate_user');
        if (typeof showToast === 'function') {
          showToast('Logged Out', 'You have been logged out successfully', 'success', 2000);
        }
        setTimeout(() => {
          window.location.href = 'splash.html';
        }, 500);
      }
    }
  </script>
</body>
</html>
